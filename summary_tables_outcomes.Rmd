---
title: "Summary Tables"
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
library(knitr)
library(pracma)
library(summarytools)
library(dplyr)
library(purrr)
library(DT)
knitr::opts_chunk$set(comment=NA, prompt=FALSE, cache=FALSE, echo=F, results='asis')

```


```{r loadLibraries, echo = F, message = F}

st_options(bootstrap.css     = FALSE,       # Already part of the theme so no need for it
             plain.ascii       = FALSE,       # One of the essential settings
             style             = "rmarkdown", # Idem.
           dfSummary.silent  = TRUE,        # Suppresses messages about temporary files
           footnote          = NA,          # Keeping the results minimalistic
           subtitle.emphasis = FALSE)       # For the vignette theme, this gives
                                            # much better results. Your mileage may vary

```

```{r load_objects = "asis"}
io <- readRDS("results/multi_city/io.rds")
# Assumes that multi_city_script.R has been run till 
cities <- c('accra','sao_paulo','delhi','bangalore', 'santiago', 'belo_horizonte', 'buenos_aires', 'mexico_city','bogota','cape_town', 'vizag')

round_to <- 1

# Set plot_mmets to F
plot_mmets <- F

sum_and_round_and_print <- function(data,text=''){
  data <- lapply(data, function(x)round(x,round_to))
  data <- lapply(data,function(x)rbind(x,Total=colSums(x)))
  for(city in cities) {
    print(kable(data[[city]], caption = paste(text, city)))
    cat("\n")
  }
}
round_and_print <- function(data,text=''){
  data <- lapply(data, function(x)round(x,round_to))
  for(city in cities) {
    print(kable(data[[city]], caption = paste(text, city)))
    cat("\n")
  }
}

```


```{r preprocessing}


collapse_ages <- function(data,ages=c('15-49','50-69'),age_lab='age_cat'){
  target_min_age <- as.numeric(sapply(ages,function(x)strsplit(x,'-')[[1]][1]))
  target_max_age <- as.numeric(sapply(ages,function(x)strsplit(x,'-')[[1]][2]))
  min_ages <- as.numeric(sapply(data[[age_lab]],function(x)strsplit(x,'-')[[1]][1]))
  max_ages <- as.numeric(sapply(data[[age_lab]],function(x)strsplit(x,'-')[[1]][2]))
  genders <- unique(data$sex)
  if(ncol(data)>3) {
    reformatted <- do.call(rbind,lapply(1:length(ages),
    function(x) t(sapply(genders,
          function(y) 
            if(ncol(data)>3) colSums(data[min_ages<=target_max_age[x]&max_ages>=target_min_age[x]&data$sex==y,-c(1,2),drop=F])
          else sum(data[min_ages<=target_max_age[x]&max_ages>=target_min_age[x]&data$sex==y,-c(1,2),drop=F])
         ))
  ))
  data.frame(age_cat=rep(ages,each=2),sex=rep(genders,2),reformatted,stringsAsFactors=F)
  }else{
  reformatted <- do.call(c,lapply(1:length(ages),
    function(x) sapply(genders,
          function(y) 
            sum(data[min_ages<=target_max_age[x]&max_ages>=target_min_age[x]&data$sex==y,-c(1,2),drop=F])
         )
  ))
  data.frame(age=rep(ages,each=2),sex=rep(genders,2),population=as.numeric(reformatted),stringsAsFactors=F)
  }
}

scen_prop <- io$scen_prop
io <- io[-2]
for(i in 1:length(io)) {
  io[[i]]$demographic$age[io[[i]]$demographic$age=='5-9'] <- '05-9'
  io[[i]]$outcomes$hb$deaths$age_cat[io[[i]]$outcomes$hb$deaths$age_cat=='5-9'] <- '05-9'
  io[[i]]$outcomes$hb$ylls$age_cat[io[[i]]$outcomes$hb$ylls$age_cat=='5-9'] <- '05-9'
  io[[i]]$outcomes$pathway_hb$deaths$age_cat[io[[i]]$outcomes$pathway_hb$deaths$age_cat=='5-9'] <- '05-9'
  io[[i]]$outcomes$pathway_hb$ylls$age_cat[io[[i]]$outcomes$pathway_hb$ylls$age_cat=='5-9'] <- '05-9'
  io[[i]]$outcomes$hb$deaths <- io[[i]]$outcomes$hb$deaths[,!sapply(names(io[[i]]$outcomes$hb$deaths),function(x)grepl('ac|neo',as.character(x)))]
  io[[i]]$outcomes$hb$ylls <- io[[i]]$outcomes$hb$ylls[,!sapply(names(io[[i]]$outcomes$hb$ylls),function(x)grepl('ac|neo',as.character(x)))]
  io[[i]]$outcomes$pathway_hb$deaths <- io[[i]]$outcomes$pathway_hb$deaths[,!sapply(names(io[[i]]$outcomes$pathway_hb$deaths),function(x)grepl('ac|neo',as.character(x)))]
  io[[i]]$outcomes$pathway_hb$ylls <- io[[i]]$outcomes$pathway_hb$ylls[,!sapply(names(io[[i]]$outcomes$pathway_hb$ylls),function(x)grepl('ac|neo',as.character(x)))]
}
for(city in cities)
  for(type in c('hb','pathway_hb'))
    for(out in c('deaths','ylls'))
      io[[city]]$outcomes[[type]][[out]] <- collapse_ages(io[[city]]$outcomes[[type]][[out]])
for(city in cities) io[[city]]$demographic <- collapse_ages(io[[city]]$demographic,age_lab='age')
pop_by_age <- lapply(io,function(x)sapply(unique(x$demographic$age),function(y)sum(subset(x$demographic,age==y)$population)))
pop_by_gender <- lapply(io,function(x)sapply(unique(x$demographic$sex),function(y)sum(subset(x$demographic,sex==y)$population)))
injury_col <- which(colnames(io[[1]]$outcomes$hb$deaths)=='scen1_deaths_inj')
ap_cols <- which(sapply(colnames(io[[1]]$outcomes$pathway_hb$deaths),function(x)grepl('ap',as.character(x))))
pa_cols <- which(sapply(colnames(io[[1]]$outcomes$pathway_hb$deaths),function(x)grepl('pa',as.character(x))))
scen_names <- rownames(scen_prop)

```

## Who Hit Whom matrix

Who hit whom matrix for all scenarios for each case study

### Who hit whom matrix {#whw}

```{r whw}

all_whw <- list()

for(city in cities){
  if (!city %in% c('buenos_aires', 'mexico_city')){
     # city <- 'buenos_aires'
    for (cs in names(io$accra$outcomes$whw)){
      print(city)
      
      if (is.null(io[[city]]$outcomes$whw[[cs]]$whw)){
        if (!is.null(io[[city]]$outcomes$whw[[cs]]$nov)){
          td2 <- t(io[[city]]$outcomes$whw[[cs]]$nov) %>% as.data.frame()
          td2$mode <- 'NOV'
          
          td2 <- td2 %>% dplyr::select(mode, names(.))
          
          td3 <- td2
        }
        
      }else{
        td1 <- (io[[city]]$outcomes$whw[[cs]]$whw) %>% as.data.frame() %>% tibble::rownames_to_column("mode")
        td3 <- td1
        if (!is.null(io[[city]]$outcomes$whw[[cs]]$nov)){
          td2 <- t(io[[city]]$outcomes$whw[[cs]]$nov) %>% as.data.frame()
          td2$mode <- 'NOV'
          
          td3 <- plyr::rbind.fill(td1, td2)
        }
      }
      td3 <- td3 %>% mutate(rowSum = rowSums(.[2:ncol(td3)], na.rm = T))
      td3 <- td3 %>% janitor::adorn_totals("row")
      td3[, 2:ncol(td3)] <- round(td3[, 2:ncol(td3)], 2)
        
      print(kable(format(td3, scientific = F), caption = paste('Who Hit Whom (WHW) ', cs, ' matrix for ', city)))
      cat("\n")
      
      td <- td3
      names(td)[2:ncol(td)] <- paste(names(td)[2:ncol(td)], city, sep = "_")
    
      all_whw[[cs]][[city]] <- td
    }

  }
}

```


### Who hit whom matrix for all case cities {#whw_all}

```{r whw_for_all_cs}

st <- list()

td <- NULL

for (cs in names(all_whw)){
  # cs <- 'Baseline'
  
  td <- all_whw[[cs]] %>% purrr::reduce(full_join, by = "mode") %>% as.data.frame() %>% dplyr::select(mode, sort(names(.)))
  
   td[is.na(td)] <- 0
   
   unk <- td %>% filter(mode %in% c('unknown', 'unk')) %>% summarise_if(is.numeric, funs(sum)) %>% mutate(mode = 'unknown')
   
   unsp <- td %>% filter(mode %in% c('unspecified', 'listed_na', '?')) %>% summarise_if(is.numeric, funs(sum)) %>% mutate(mode = 'unspecified')
   
   other <- unsp <- td %>% filter(mode %in% c('other', 'non.motor.vehicle', 'tract', 'railway.train.railway.vehicle')) %>% summarise_if(is.numeric, funs(sum)) %>% mutate(mode = 'other')
   
   pu <- td %>% filter(mode %in% c('picku', 'pickup/light goods')) %>% summarise_if(is.numeric, funs(sum)) %>% mutate(mode = 'pickup')
   
   bus <- td %>% filter(mode %in% c('bus', 'bus_driver')) %>% summarise_if(is.numeric, funs(sum)) %>% mutate(mode = 'bus')
   
   td <- td %>% filter(!mode %in% c('bus', 'bus_driver', 'unknown', 'unk', 'unspecified', 'listed_na', '?', 
                                  'other', 'non.motor.vehicle', 'tract', 'railway.train.railway.vehicle',
                                  'picku', 'pickup/light goods'))
   
   td <- plyr::rbind.fill(td, bus, unk, unsp, other, pu)
   
   td <- (td[!duplicated(td), ])
   
   td <- rbind(td %>% dplyr::filter(!mode %in% c("Total", "NOV")) %>% arrange(mode), td %>% filter(mode == 'NOV'), td %>% filter(mode == 'Total'))
   
   td[is.na(td)] <- 0
   
   td <- td %>% mutate_if(is.numeric, round, 2)
   
   readr::write_csv(td, paste0('results/multi_city/whw_matrices/whw_', cs, '.csv'))
   
   st[[cs]] <- format(td, scientific = F)
  
  print(kable(format(td, scientific = F), caption = paste('Who Hit Whom (WHW) for all case cities for ', cs)))
  
}

```

### DT - Who hit whom matrix for all case cities {#whw_all}
Baseline

```{r dt}

#for (cs in names(all_whw)){
td <- NULL

cs <- 'Baseline'

fname <- paste("whw", cs)

td <- st[[cs]]

DT::datatable(td, 
              extensions = 'Buttons',
              escape = FALSE,
              rownames = FALSE,
              options = list(dom = 'Bfrtip',
                             buttons = 
                               list('colvis', list(
                                 extend = 'collection',
                                 buttons = list(list(extend='csv',
                                                     filename = fname),
                                                list(extend='excel',
                                                     filename = fname)),
                                 text = 'Download'
                               )),
                             scrollX = TRUE,
                             pageLength = nrow(td),
                             order=list(list(2,'desc')),
                             columnDefs = list(list(visible=FALSE, targets=c(1:(ncol(td) - 1))))))

# }

```


## TOTAL

Change in deaths total (for the city based on real population size) by age group by scenario

### Change in deaths {#change_death}

```{r scen_prop = "asis"}
death_totals <- lapply(io,function(x){
  temp <- sapply(1:5,function(y){
    xx <- x$outcomes$hb$deaths
    xxx <- rowSums(xx[,seq(2+y,ncol(xx),by=5)])
    sapply(sort(unique(xx$age_cat)),function(z)
      sum(xxx[xx$age_cat==z]))
  })
  #rownames(temp) <- apply(x$outcomes$hb$deaths[,1:2],1,function(z)paste0(z[1],'_',z[2]))
  colnames(temp) <- scen_names
  temp
  })

sum_and_round_and_print(death_totals,"Change in deaths total in ")
```

Change in deaths per 100,000 people by age group by scenario

### Change in deaths per 100,000 {#change_death_100k}

```{r scen_prop = "asis"}
death_rates <- lapply(cities,function(x) rbind(death_totals[[x]]/t(repmat(pop_by_age[[x]],5,1))*100000, Total=colSums(death_totals[[x]])/rep(sum(pop_by_age[[x]]),length=5)*100000))
names(death_rates) <- cities

round_and_print(death_rates,"Change in deaths per 100,000 in ")
```

YLLs total (for the city based on real population size) by age group  by scenario

### Change in YLL {#change_YLL}

```{r scen_prop = "asis"}
yll_totals <- lapply(io,function(x){
  temp <- sapply(1:5,function(y){
    xx <- x$outcomes$hb$ylls
    xxx <- rowSums(xx[,seq(2+y,ncol(xx),by=5)])
    sapply(sort(unique(xx$age_cat)),function(z)
      sum(xxx[xx$age_cat==z]))
  })
  colnames(temp) <- scen_names
  temp
  })
sum_and_round_and_print(yll_totals,"Change in YLL total in ")
```

YLLs per 100,000 people by age group by scenario

### Change in YLLs per 100,000 {#change_YLL_age_100k}

```{r scen_prop = "asis"}
yll_rates <- lapply(cities,function(x) rbind(yll_totals[[x]]/t(repmat(pop_by_age[[x]],5,1))*100000, Total=colSums(yll_totals[[x]])/rep(sum(pop_by_age[[x]]),length=5)*100000))
names(yll_rates) <- cities
round_and_print(yll_rates,"Change in YLLs per 100,000 in ")
```

YLLs per 100,000 people by gender by age group scenario

### Change in YLLs per 100,000 {#change_YLL_gender_age_100k}

```{r scen_prop = "asis"}
yll_totals <- lapply(io,function(x){
  temp <- sapply(1:5,function(y){
    xx <- x$outcomes$hb$ylls
    rowSums(xx[,seq(2+y,ncol(xx),by=5)])
  })
  rownames(temp) <- apply(x$outcomes$hb$deaths[,1:2],1,function(z)paste0(z[1],'_',z[2]))
  colnames(temp) <- scen_names
  temp
  })

yll_rates <- lapply(cities,function(x) 
  rbind(yll_totals[[x]][match(apply(io[[x]]$demographic[,c('sex','age')],1,function(z)paste0(z[2],'_',z[1])),rownames(yll_totals[[x]])),]/
    t(repmat(io[[x]]$demographic$population,5,1))*100000, Total=colSums(yll_totals[[x]])/rep(sum(pop_by_age[[x]]),length=5)*100000))
names(yll_rates) <- cities
round_and_print(yll_rates,"Change in YLLs per 100,000 in ")
``` 

 
## BY PATHWAY

By pathway (with non- injury separate & summed)

Change in deaths total (for the city based on real population size) by age group by scenario

### Change in deaths due to injury {#change_death_injury}

```{r}
injury_totals <- lapply(io,function(x){
  xx <- x$outcomes$hb$deaths
  xxx <- sapply(1:5,function(y)sapply(sort(unique(xx$age_cat)),function(z)sum(xx[xx$age_cat==z,injury_col-1+y])))
  colnames(xxx) <- scen_names
  xxx
  })
sum_and_round_and_print(injury_totals,"Change in deaths due to injury in ")
```

### Change in deaths due to injury per 100,000 km

```{r inj_100k = "asis"}
require(tibble)

overall_el <- list()

for (city in cities){
  
  #city <- 'delhi'
  
  print(city)
  
  el <- list()
  
  #if (!city %in% c('buenos_aires', 'mexico_city', 'bogota', 'vizag')){
    
    for (cs in names(io[[city]]$outcomes$whw)){
      # cs <- 'Baseline'
      # city <- 'mexico_city'
      if (length(names(io[[city]]$outcomes$whw$Baseline)) == 2){
      td1 <- round(io[[city]]$outcomes$whw[[cs]]$nov) %>% as.data.frame() %>% rownames_to_column() %>% rename(mode = rowname) %>% rename_at(2, ~"count")
      td2 <- colSums(round(io[[city]]$outcomes$whw[[cs]]$whw)) %>% as.data.frame() %>% rownames_to_column() %>% rename(mode = rowname) %>% rename_at(2, ~"count")
      td3 <- left_join(td2, td1, by = 'mode') %>% mutate(count = rowSums(.[2:3], na.rm = T))
      td3[td3$mode == 'pedestrian', ]$mode <- 'walking'
      
      }else if(names(io[[city]]$outcomes$whw$Baseline) == 'whw'){
        td3 <- colSums(round(io[[city]]$outcomes$whw[[cs]]$whw)) %>% as.data.frame() %>% rownames_to_column() %>% rename(mode = rowname) %>% rename_at(2, ~"count")
        td3[td3$mode == 'pedestrian', ]$mode <- 'walking'
      }else {
        
        td3 <- round(io[[city]]$outcomes$whw[[cs]]$nov) %>% as.data.frame() %>% rownames_to_column() %>% rename(mode = rowname) %>% rename_at(2, ~"count")
        td3[td3$mode == 'pedestrian', ]$mode <- 'walking'
        
      }
      
      td4 <- io[[city]]$true_dist %>% filter(stage_mode %in% td3$mode) %>% dplyr::select(stage_mode, cs)
      
      if (length(el) == 0){
        el <- td4 %>% dplyr::select(stage_mode)
      }
      
      td4 <- left_join(td4, td3 %>% dplyr::select(mode, count) %>% rename(stage_mode = mode), by = 'stage_mode')
      
      td5 <- td4
      
      td4[, 2] <- round((td4[,3] / td4[,2]) * 100000, 1)
      
      names(td4)[3] <- paste(names(td4)[2], names(td4)[3], sep = "_")
      
      el <- inner_join(el, td4, by = 'stage_mode')
      
      
      
      # for (i in 1:nrow(td4)){
      #   td4[i, 2:(ncol(td4) - 2)] <- round((td4$total[i] /(td4[i, 2:6])) * 100000, 1)
      #   
      #   
      # }
      
      # print(td4)
    }
    print(kable(el, caption = city))
    
    td <- el %>% dplyr::select(-contains('count'))
    names(td)[2:ncol(td)] <- paste(names(td)[2:ncol(td)], city, sep = "_")
    
    overall_el[[city]] <- td
    
    cat("\n")
    #kable(print(el), caption = city)
  #}
  
  
  
}
```


### Change in deaths due to injury per 100,000 km across cities

```{r inj_100k_all_cities = "asis"}
require(tibble)

td <- overall_el %>% purrr::reduce(full_join, by = "stage_mode") %>% as.data.frame()

td <- td %>% dplyr::select(stage_mode, sort(names(.)))

readr::write_csv(td, 'results/multi_city/whw_matrices/injury_risks.csv')

print(kable(format(td, scientific = F), caption = paste('Injury per 100k across all cities')))


```


### Change in deaths due to PA {#change_death_PA}

```{r}

pa_totals <- lapply(io,function(x){
  xx <- x$outcomes$pathway_hb$deaths
  xxx <- sapply(1:5,function(y){
    xxx <- rowSums(xx[,pa_cols[seq(y,length(pa_cols),by=5)]])
    sapply(sort(unique(xx$age_cat)),function(z)sum(xxx[xx$age_cat==z]))
  })
  colnames(xxx) <- scen_names
  xxx
  })
sum_and_round_and_print(pa_totals,"Change in deaths due to PA in ")
```

### Change in deaths due to AP {#change_death_AP}

```{r}
ap_totals <- lapply(io,function(x){
  xx <- x$outcomes$pathway_hb$deaths
  xxx <- sapply(1:5,function(y){
    xxx <- rowSums(xx[,ap_cols[seq(y,length(ap_cols),by=5)]])
    sapply(sort(unique(xx$age_cat)),function(z)sum(xxx[xx$age_cat==z]))
  })
  colnames(xxx) <- scen_names
  xxx
  })
sum_and_round_and_print(ap_totals,"Change in deaths due to AP in ")
```

## Change in deaths per 100,000 people by age group by scenario

### Change in deaths due to injury per 100,000 {#change_death_injury_100k}

```{r scen_prop = "asis"}
injury_rates <- lapply(cities,function(x) rbind(injury_totals[[x]]/t(repmat(pop_by_age[[x]],5,1))*100000, Total=colSums(injury_totals[[x]])/rep(sum(pop_by_age[[x]]),length=5)*100000))
names(injury_rates) <- cities
round_and_print(injury_rates,"Change in deaths due to injury per 100,000 in ")
```

### Change in deaths due to PA per 100,000 {#change_death_PA_100k}
```{r}
pa_rates <- lapply(cities,function(x) rbind(pa_totals[[x]]/t(repmat(pop_by_age[[x]],5,1))*100000, Total=colSums(pa_totals[[x]])/rep(sum(pop_by_age[[x]]),length=5)*100000))
names(pa_rates) <- cities
round_and_print(pa_rates,"Change in deaths due to PA per 100,000 in ")

```

### Change in deaths due to AP per 100,000 {#change_death_AP_100k}
```{r}

ap_rates <- lapply(cities,function(x) rbind(ap_totals[[x]]/t(repmat(pop_by_age[[x]],5,1))*100000, Total=colSums(ap_totals[[x]])/rep(sum(pop_by_age[[x]]),length=5)*100000))
names(ap_rates) <- cities
round_and_print(ap_rates,"Change in deaths due to AP per 100,000 in ")
```

YLLs total (for the city based on real population size) by age group by scenario

### Change in YLLs due to injury {#change_yll_injury}

```{r}
injury_totals <- lapply(io,function(x){
  xx <- x$outcomes$hb$ylls
  xxx <- sapply(1:5,function(y)sapply(sort(unique(xx$age_cat)),function(z)sum(xx[xx$age_cat==z,injury_col-1+y])))
  colnames(xxx) <- scen_names
  xxx
  })
sum_and_round_and_print(injury_totals,"Change in YLLs due to injury in ")
```

### Change in YLLs due to PA {#change_yll_PA}
```{r}
pa_totals <- lapply(io,function(x){
  xx <- x$outcomes$pathway_hb$ylls
  xxx <- sapply(1:5,function(y){
    xxx <- rowSums(xx[,pa_cols[seq(y,length(pa_cols),by=5)]])
    sapply(sort(unique(xx$age_cat)),function(z)sum(xxx[xx$age_cat==z]))
  })
  colnames(xxx) <- scen_names
  xxx
  })
sum_and_round_and_print(pa_totals,"Change in YLLs due to PA in ")
```

### Change in YLLs due to AP {#change_yll_AP}
```{r}
ap_totals <- lapply(io,function(x){
  xx <- x$outcomes$pathway_hb$ylls
  xxx <- sapply(1:5,function(y){
    xxx <- rowSums(xx[,ap_cols[seq(y,length(ap_cols),by=5)]])
    sapply(sort(unique(xx$age_cat)),function(z)sum(xxx[xx$age_cat==z]))
  })
  colnames(xxx) <- scen_names
  xxx
  })
sum_and_round_and_print(ap_totals,"Change in YLLs due to AP in ")
```

YLLs per 100,000 people by age group by scenario

### Change in YLLs due to injury per 100,000 {#change_yll_injury_100k}

```{r scen_prop = "asis"}
injury_rates <- lapply(cities,function(x) rbind(injury_totals[[x]]/t(repmat(pop_by_age[[x]],5,1))*100000, Total=colSums(injury_totals[[x]])/rep(sum(pop_by_age[[x]]),length=5)*100000))
names(injury_rates) <- cities
round_and_print(injury_rates,"Change in YLLs due to injury per 100,000 in ")
```

### Change in YLLs due to PA per 100,000 {#change_yll_PA_100k}
```{r}
pa_rates <- lapply(cities,function(x) rbind(pa_totals[[x]]/t(repmat(pop_by_age[[x]],5,1))*100000, Total=colSums(pa_totals[[x]])/rep(sum(pop_by_age[[x]]),length=5)*100000))
names(pa_rates) <- cities
round_and_print(pa_rates,"Change in YLLs due to PA per 100,000 in ")
```

### Change in YLLs due to injury AP 100,000 {#change_yll_AP_100k}
```{r}
ap_rates <- lapply(cities,function(x) rbind(ap_totals[[x]]/t(repmat(pop_by_age[[x]],5,1))*100000, Total=colSums(ap_totals[[x]])/rep(sum(pop_by_age[[x]]),length=5)*100000))
names(ap_rates) <- cities
round_and_print(ap_rates,"Change in YLLs due to AP per 100,000 in ")
```

## BY DISEASE

Change in deaths total (for the city based on real population size) by scenario

### Change in deaths due to disease {#change_death_disease}

```{r}

disease_totals <- lapply(io,function(x){
  xx <- x$outcomes$hb$deaths
  xxx <- sapply(1:5,function(y){
    colSums(xx[,seq(y+2,ncol(xx),by=5)])
  })
  colnames(xxx) <- scen_names
  rownames(xxx) <- sapply(rownames(xxx),function(y)gsub('scen1_','',y))
  xxx
  })
sum_and_round_and_print(disease_totals,"Change in deaths due to disease in ")


```

Change in deaths per 100,000 people by scenario

### Change in deaths due to disease per 100,000 {#change_death_disease_100k}

```{r scen_prop = "asis"}
disease_rates <- lapply(cities,function(x) rbind(disease_totals[[x]]/sum(pop_by_age[[x]])*100000, Total=colSums(disease_totals[[x]])/rep(sum(pop_by_age[[x]]),length=5)*100000))
names(disease_rates) <- cities
round_and_print(disease_rates,"Change in deaths due to disease per 100,000 in ")
```

Change in YLL total (for the city based on real population size) by scenario

### Change in YLL due to disease {#change_yll_disease}

```{r}

disease_totals <- lapply(io,function(x){
  xx <- x$outcomes$hb$ylls
  xxx <- sapply(1:5,function(y){
    colSums(xx[,seq(y+2,ncol(xx),by=5)])
  })
  colnames(xxx) <- scen_names
  rownames(xxx) <- sapply(rownames(xxx),function(y)gsub('scen1_','',y))
  xxx
  })
sum_and_round_and_print(disease_totals,"Change in YLL due to disease in ")

```

### Change in YLL due to disease per 100,000 {#change_yll_disease_100k}

```{r scen_prop = "asis"}
disease_rates <- lapply(cities,function(x) rbind(disease_totals[[x]]/sum(pop_by_age[[x]])*100000, Total=colSums(disease_totals[[x]])/rep(sum(pop_by_age[[x]]),length=5)*100000))
names(disease_rates) <- cities
round_and_print(disease_rates,"Change in YLL due to disease per 100,000 in ")
```
